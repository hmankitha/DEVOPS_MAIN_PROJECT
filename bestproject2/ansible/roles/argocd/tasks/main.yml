---
# Ansible Role: ArgoCD
# Deploys and configures ArgoCD for GitOps continuous delivery

- name: Check if kubectl is installed
  command: kubectl version --client
  register: kubectl_check
  changed_when: false
  failed_when: false

- name: Fail if kubectl is not installed
  fail:
    msg: "kubectl is not installed. Please install kubectl first."
  when: kubectl_check.rc != 0

- name: Check if Kubernetes cluster is accessible
  command: kubectl cluster-info
  register: cluster_check
  changed_when: false
  failed_when: false

- name: Fail if Kubernetes cluster is not accessible
  fail:
    msg: "Cannot connect to Kubernetes cluster. Please check your kubeconfig."
  when: cluster_check.rc != 0

- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    name: argocd
    api_version: v1
    kind: Namespace
    state: present

- name: Install ArgoCD
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('url', 'https://raw.githubusercontent.com/argoproj/argo-cd/v2.9.3/manifests/install.yaml', split_lines=False) }}"
    namespace: argocd

- name: Wait for ArgoCD pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: argocd
    label_selectors:
      - app.kubernetes.io/name=argocd-server
  register: argocd_pods
  until: argocd_pods.resources | length > 0 and argocd_pods.resources[0].status.phase == "Running"
  retries: 30
  delay: 10

- name: Get ArgoCD initial admin password
  kubernetes.core.k8s_info:
    kind: Secret
    name: argocd-initial-admin-secret
    namespace: argocd
  register: argocd_secret

- name: Decode ArgoCD admin password
  set_fact:
    argocd_admin_password: "{{ argocd_secret.resources[0].data.password | b64decode }}"
  when: argocd_secret.resources | length > 0

- name: Apply ArgoCD AppProject
  kubernetes.core.k8s:
    state: present
    src: "{{ project_root }}/argocd/projects/microservices-project.yaml"

- name: Apply ArgoCD Applications
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
  loop:
    - "{{ project_root }}/argocd/applications/product-catalog.yaml"
    - "{{ project_root }}/argocd/applications/user-management.yaml"
  when: deploy_applications | default(false)

- name: Check if ArgoCD CLI is installed
  command: argocd version --client
  register: argocd_cli_check
  changed_when: false
  failed_when: false

- name: Install ArgoCD CLI (macOS)
  homebrew:
    name: argocd
    state: present
  when: 
    - argocd_cli_check.rc != 0
    - ansible_os_family == "Darwin"

- name: Display ArgoCD access information
  debug:
    msg:
      - "================================================"
      - "‚úÖ ArgoCD Installation Complete!"
      - "================================================"
      - ""
      - "üìù Access Information:"
      - ""
      - "1Ô∏è‚É£  Port Forward ArgoCD Server:"
      - "   kubectl port-forward svc/argocd-server -n argocd 8081:443"
      - ""
      - "2Ô∏è‚É£  Access ArgoCD UI:"
      - "   https://localhost:8081"
      - ""
      - "3Ô∏è‚É£  Login Credentials:"
      - "   Username: admin"
      - "   Password: {{ argocd_admin_password }}"
      - ""
      - "4Ô∏è‚É£  Login via CLI:"
      - "   argocd login localhost:8081 --username admin --password {{ argocd_admin_password }} --insecure"
      - ""
      - "================================================"
