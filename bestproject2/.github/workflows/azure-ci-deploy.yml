name: CI to Azure (ACA)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RG_NAME: bestproject2-rg
  LOCATION: eastus

jobs:
  build_and_push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Resource Group
        run: az group create -n $RG_NAME -l $LOCATION

      - name: Deploy infra (ACR + ACA env + KV)
        run: |
          az deployment group create \
            -g $RG_NAME \
            -f infrastructure/azure/bicep/main.bicep \
            -p location=$LOCATION

      - name: Get ACR login server
        id: acr
        run: |
          ACR=$(az deployment group show -g $RG_NAME -n apps --query properties.outputs.acrLoginServer.value -o tsv || true)
          if [ -z "$ACR" ]; then
            # fallback: find ACR in RG
            ACR=$(az acr list -g $RG_NAME --query '[0].loginServer' -o tsv)
          fi
          echo "login_server=$ACR" >> $GITHUB_OUTPUT

      - name: ACR Login
        run: az acr login -n $(echo "${{ steps.acr.outputs.login_server }}" | cut -d. -f1)

      - name: Set image tags
        id: tags
        run: |
          echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "pc=${{ steps.acr.outputs.login_server }}/product-catalog:${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "um=${{ steps.acr.outputs.login_server }}/user-management:${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "om=${{ steps.acr.outputs.login_server }}/order-management:${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push product-catalog
        run: |
          docker build -t ${{ steps.tags.outputs.pc }} microservices/product-catalog
          docker push ${{ steps.tags.outputs.pc }}

      - name: Build and push user-management
        run: |
          docker build -t ${{ steps.tags.outputs.um }} microservices/user-management
          docker push ${{ steps.tags.outputs.um }}

      - name: Build and push order-management
        run: |
          docker build -t ${{ steps.tags.outputs.om }} microservices/order-management
          docker push ${{ steps.tags.outputs.om }}

      - name: Generate SBOMs (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: |
            ${{ steps.tags.outputs.pc }}
            ${{ steps.tags.outputs.um }}
            ${{ steps.tags.outputs.om }}
          format: spdx-json

      - name: Cosign sign images (keyless)
        if: ${{ vars.COSIGN_ENABLED == 'true' }}
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          curl -sSL https://raw.githubusercontent.com/sigstore/cosign/main/install.sh | sudo sh -s -- -b /usr/local/bin latest
          cosign sign --yes ${{ steps.tags.outputs.pc }}
          cosign sign --yes ${{ steps.tags.outputs.um }}
          cosign sign --yes ${{ steps.tags.outputs.om }}

  deploy_staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build_and_push
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get ACR login server
        id: acr
        run: |
          ACR=$(az acr list -g ${{ env.RG_NAME }} --query '[0].loginServer' -o tsv)
          echo "login_server=$ACR" >> $GITHUB_OUTPUT
      - name: Deploy updated images
        run: |
          az deployment group create \
            -g $RG_NAME \
            -f infrastructure/azure/bicep/main.bicep \
            -p productCatalogImage=${{ steps.acr.outputs.login_server }}/product-catalog:${GITHUB_SHA::7} \
               userManagementImage=${{ steps.acr.outputs.login_server }}/user-management:${GITHUB_SHA::7} \
               orderManagementImage=${{ steps.acr.outputs.login_server }}/order-management:${GITHUB_SHA::7}

  deploy_prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy_staging
    environment:
      name: production
      url: https://portal.azure.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get ACR login server
        id: acr
        run: |
          ACR=$(az acr list -g ${{ env.RG_NAME }} --query '[0].loginServer' -o tsv)
          echo "login_server=$ACR" >> $GITHUB_OUTPUT
      - name: Deploy updated images
        run: |
          az deployment group create \
            -g $RG_NAME \
            -f infrastructure/azure/bicep/main.bicep \
            -p productCatalogImage=${{ steps.acr.outputs.login_server }}/product-catalog:${GITHUB_SHA::7} \
               userManagementImage=${{ steps.acr.outputs.login_server }}/user-management:${GITHUB_SHA::7} \
               orderManagementImage=${{ steps.acr.outputs.login_server }}/order-management:${GITHUB_SHA::7}
